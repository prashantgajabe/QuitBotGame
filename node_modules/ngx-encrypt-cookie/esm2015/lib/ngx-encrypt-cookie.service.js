/**
 * @fileoverview added by tsickle
 * Generated from: lib/ngx-encrypt-cookie.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Inject, PLATFORM_ID, InjectionToken } from '@angular/core';
import { isPlatformBrowser } from '@angular/common';
import * as CryptoJS from 'crypto-js';
import * as i0 from "@angular/core";
export class NgxEncryptCookieService {
    /**
     * @param {?} platformId
     */
    constructor(platformId) {
        this.platformId = platformId;
        this.documentIsAccessible = isPlatformBrowser(this.platformId);
    }
    /**
     * @param {?=} keySize Cookie name
     * @param {?=} passPhrase secret passPhrase
     * @return {?} returns key when setting cookie and getting cookie
     * default keySize is 128/32 and default passPhrase is "Secret PassPhrase"
     */
    generateKey(keySize, passPhrase) {
        /** @type {?} */
        var salt = CryptoJS.lib.WordArray.random(128 / 8);
        /** @type {?} */
        var keySizeBytes;
        /** @type {?} */
        var secrtePassPhrase;
        keySize ? keySizeBytes = keySize : keySizeBytes = "128/32";
        passPhrase ? secrtePassPhrase = passPhrase : secrtePassPhrase = "Secret PassPhrase";
        switch (keySizeBytes) {
            case "128/32":
                /** @type {?} */
                var msg = CryptoJS.PBKDF2(secrtePassPhrase, salt, { keySize: 128 / 32 });
                return msg.toString();
                break;
            case "256/32":
                /** @type {?} */
                var msg = CryptoJS.PBKDF2(secrtePassPhrase, salt, { keySize: 256 / 32 });
                return msg.toString();
                break;
            case "512/32":
                /** @type {?} */
                var msg = CryptoJS.PBKDF2(secrtePassPhrase, salt, { keySize: 512 / 32 });
                return msg.toString();
                break;
        }
    }
    /**
     * encrypt() is calling when set() calls
     * @private
     * @param {?} val value to store in cookies
     * @param {?} secret_key is a key generated by using generateKey() or user defined key.
     * @return {?} encrypted val to set() and there the cookie will set. if user doesnt generateKey or pass key error will be thrown.
     */
    encrypt(val, secret_key) {
        if (secret_key != null || secret_key != "" || secret_key.length > 0) {
            /** @type {?} */
            var encrypt_msg = CryptoJS.AES.encrypt(val, secret_key);
            return encrypt_msg;
        }
        else {
            console.error("Pass Secret key to set cookie");
        }
    }
    /**
     *
     * @private
     * @param {?} cookieName
     * @param {?} encrypted boolean - cookie stored having encrypted val or not
     * @param {?=} secret_key is key which is used to encrypt cookie val. it is not required if encrypted is false
     * @return {?}
     */
    decrypt(cookieName, encrypted, secret_key) {
        if (this.documentIsAccessible && this.check(cookieName)) {
            cookieName = encodeURIComponent(cookieName);
            /** @type {?} */
            const regExp = this.getCookieRegExp(cookieName);
            /** @type {?} */
            const result = regExp.exec(document.cookie);
            if (encrypted) {
                if (secret_key) {
                    /** @type {?} */
                    let encrypt_msg = this.safeDecodeURIComponent(result[1]);
                    /** @type {?} */
                    let decrypt_msg = CryptoJS.AES.decrypt(encrypt_msg, secret_key);
                    /** @type {?} */
                    let message = decrypt_msg.toString(CryptoJS.enc.Utf8);
                    return message;
                }
                else {
                    console.error("pass secret key to get cookie value");
                }
            }
            else {
                return this.safeDecodeURIComponent(result[1]);
            }
        }
        else {
            return '';
        }
    }
    /**
     * @param {?} cookieName Cookie name
     * @return {?} boolean  whether cookie with specified name is existed or not
     */
    check(cookieName) {
        if (!this.documentIsAccessible) {
            return false;
        }
        /** @type {?} */
        var name = encodeURIComponent(cookieName);
        /** @type {?} */
        const regExp = this.getCookieRegExp(name);
        /** @type {?} */
        const exists = regExp.test(document.cookie);
        return exists;
    }
    /**
     *
     * @param {?} cookieName cookie name
     * @param {?} encryption boolean - whether to want encrypted or decrypted value.
     * @param {?=} key - it should enter if encrypted=true otherwise error will be thrown.key can be either generated using generateKey() or
     * user definded key
     * @return {?}
     */
    get(cookieName, encryption, key) {
        /** @type {?} */
        var val;
        if (encryption) {
            if (key) {
                val = this.decrypt(cookieName, encryption, key);
                return val;
            }
        }
        // if key is not passed or encrypted = false;
        val = this.decrypt(cookieName, false, null);
        return val;
    }
    /**
     * @param {?=} encrypted boolean - to know encrypted values are there
     * @param {?=} key  generatedKey() or user defined key - to decrypt encrypted values
     * @return {?} cookies - all the cookies  stored
     */
    getAll(encrypted, key) {
        if (!this.documentIsAccessible) {
            return {};
        }
        /** @type {?} */
        const cookies = {};
        if (encrypted) {
            if (document.cookie && document.cookie !== '') {
                document.cookie.split(';').forEach((/**
                 * @param {?} currentCookie
                 * @return {?}
                 */
                (currentCookie) => {
                    const [cookieName, cookieValue] = currentCookie.split('=');
                    /** @type {?} */
                    var cookie_name = this.safeDecodeURIComponent(cookieName.replace(/^ /, ''));
                    /** @type {?} */
                    var cookie_val = this.get(cookie_name, encrypted, key);
                    cookies[this.safeDecodeURIComponent(cookieName.replace(/^ /, ''))] = cookie_val;
                    // cookies[]
                }));
            }
        }
        else {
            if (document.cookie && document.cookie !== '') {
                document.cookie.split(';').forEach((/**
                 * @param {?} currentCookie
                 * @return {?}
                 */
                (currentCookie) => {
                    const [cookieName, cookieValue] = currentCookie.split('=');
                    /** @type {?} */
                    var cookie_name = this.safeDecodeURIComponent(cookieName.replace(/^ /, ''));
                    cookies[this.safeDecodeURIComponent(cookieName.replace(/^ /, ''))] = this.safeDecodeURIComponent(cookieValue);
                    // cookies[]
                }));
            }
        }
        return cookies;
    }
    /**
     * @private
     * @return {?}
     */
    getAllCookies() {
        if (!this.documentIsAccessible) {
            return {};
        }
        /** @type {?} */
        const cookies = {};
        if (document.cookie && document.cookie !== '') {
            document.cookie.split(';').forEach((/**
             * @param {?} currentCookie
             * @return {?}
             */
            (currentCookie) => {
                const [cookieName, cookieValue] = currentCookie.split('=');
                /** @type {?} */
                var cookie_name = this.safeDecodeURIComponent(cookieName.replace(/^ /, ''));
                cookies[this.safeDecodeURIComponent(cookieName.replace(/^ /, ''))] = this.safeDecodeURIComponent(cookieValue);
                // cookies[]
            }));
        }
        return cookies;
    }
    /**
     * @param {?} name     Cookie name
     * @param {?} value    Cookie value
     * @param {?} encrypt  boolean - to encrypt cookie value or not
     * @param {?=} key      a key can either generate using generateKey() or user defined key
     * @param {?=} expires  Number of days until the cookies expires or an actual `Date`
     * @param {?=} path     Cookie path (eg:"/")
     * @param {?=} domain   Cookie domain (eg:"domain.com")
     * @param {?=} secure   Secure flag
     * @param {?=} sameSite OWASP samesite token `Lax`, `None`, or `Strict`. Defaults to `Lax`
     * @return {?}
     */
    set(name, value, encrypt, key, expires, path, domain, secure, sameSite = 'Lax') {
        /** @type {?} */
        var cookieString;
        if (!this.documentIsAccessible) {
            return;
        }
        if (encrypt) {
            if (key) {
                /** @type {?} */
                let encrypted_msg = this.encrypt(value, key);
                cookieString = encodeURIComponent(name) + '=' + encodeURIComponent(encrypted_msg) + ';';
            }
            else {
                console.error("pass key to encrypt cookie value");
                return "key fail";
            }
        }
        else {
            cookieString = encodeURIComponent(name) + '=' + encodeURIComponent(value) + ';';
        }
        if (expires) {
            if (typeof expires === 'number') {
                /** @type {?} */
                const dateExpires = new Date(new Date().getTime() + expires * 1000 * 60 * 60 * 24);
                cookieString += 'expires=' + dateExpires.toUTCString() + ';';
            }
            else {
                cookieString += 'expires=' + expires.toUTCString() + ';';
            }
        }
        if (path) {
            cookieString += 'path=' + path + ';';
        }
        if (domain) {
            cookieString += 'domain=' + domain + ';';
        }
        if (secure === false && sameSite === 'None') {
            secure = true;
            console.warn(`[ngx-secure-cookies] Cookie ${name} was forced with secure flag because sameSite=None.`);
        }
        if (secure) {
            cookieString += 'secure;';
        }
        cookieString += 'sameSite=' + sameSite + ';';
        document.cookie = cookieString;
        return true;
    }
    /**
     * @param {?} name   Cookie name
     * @param {?=} path   Cookie path
     * @param {?=} domain Cookie domain
     * @param {?=} secure
     * @param {?=} sameSite
     * @return {?}
     */
    delete(name, path, domain, secure, sameSite = 'Lax') {
        if (!this.documentIsAccessible) {
            return;
        }
        this.set(name, '', false, "", new Date('Thu, 01 Jan 1970 00:00:01 GMT'), path, domain, secure, sameSite);
    }
    /**
     * @param {?=} path   Cookie path
     * @param {?=} domain Cookie domain
     * @param {?=} secure
     * @param {?=} sameSite
     * @return {?}
     */
    deleteAll(path, domain, secure, sameSite = 'Lax') {
        if (!this.documentIsAccessible) {
            return;
        }
        /** @type {?} */
        const cookies = this.getAllCookies();
        for (const cookieName in cookies) {
            if (cookies.hasOwnProperty(cookieName)) {
                this.delete(cookieName, path, domain, secure, sameSite);
            }
        }
    }
    /**
     * @private
     * @param {?} name Cookie name
     * @return {?} property RegExp
     */
    getCookieRegExp(name) {
        /** @type {?} */
        const escapedName = name.replace(/([\[\]\{\}\(\)\|\=\;\+\?\,\.\*\^\$])/gi, '\\$1');
        return new RegExp('(?:^' + escapedName + '|;\\s*' + escapedName + ')=(.*?)(?:;|$)', 'g');
    }
    /**
     * @private
     * @param {?} encodedURIComponent
     * @return {?}
     */
    safeDecodeURIComponent(encodedURIComponent) {
        try {
            return decodeURIComponent(encodedURIComponent);
        }
        catch (_a) {
            return encodedURIComponent;
        }
    }
}
NgxEncryptCookieService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
/** @nocollapse */
NgxEncryptCookieService.ctorParameters = () => [
    { type: InjectionToken, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] }
];
/** @nocollapse */ NgxEncryptCookieService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function NgxEncryptCookieService_Factory() { return new NgxEncryptCookieService(i0.ɵɵinject(i0.PLATFORM_ID)); }, token: NgxEncryptCookieService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    NgxEncryptCookieService.prototype.documentIsAccessible;
    /**
     * @type {?}
     * @private
     */
    NgxEncryptCookieService.prototype.platformId;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWVuY3J5cHQtY29va2llLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtZW5jcnlwdC1jb29raWUvIiwic291cmNlcyI6WyJsaWIvbmd4LWVuY3J5cHQtY29va2llLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsY0FBYyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hGLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3BELE9BQU8sS0FBSyxRQUFRLE1BQU0sV0FBVyxDQUFDOztBQUt0QyxNQUFNLE9BQU8sdUJBQXVCOzs7O0lBR2xDLFlBRStCLFVBQWtDO1FBQWxDLGVBQVUsR0FBVixVQUFVLENBQXdCO1FBRy9ELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDakUsQ0FBQzs7Ozs7OztJQVVELFdBQVcsQ0FBQyxPQUFnQixFQUFFLFVBQW1COztZQUUzQyxJQUFJLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUM7O1lBQzdDLFlBQVk7O1lBQ1osZ0JBQWdCO1FBRXBCLE9BQU8sQ0FBQyxDQUFDLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsWUFBWSxHQUFHLFFBQVEsQ0FBQztRQUMzRCxVQUFVLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLEdBQUcsbUJBQW1CLENBQUM7UUFFcEYsUUFBUSxZQUFZLEVBQUU7WUFDcEIsS0FBSyxRQUFROztvQkFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJLEVBQUUsRUFBRSxPQUFPLEVBQUUsR0FBRyxHQUFHLEVBQUUsRUFBRSxDQUFD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QUFLO1FBQ3JHLElBQUksQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUU7WUFDOUIsT0FBTztTQUNSOztjQUVLLE9BQU8sR0FBUSxJQUFJLENBQUMsYUFBYSxFQUFFO1FBRXpDLEtBQUssTUFBTSxVQUFVLElBQUksT0FBTyxFQUFFO1lBQ2hDLElBQUksT0FBTyxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsRUFBRTtnQkFDdEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUM7YUFDekQ7U0FDRjtJQUNILENBQUM7Ozs7OztJQVVPLGVBQWUsQ0FBQyxJQUFZOztjQUM1QixXQUFXLEdBQVcsSUFBSSxDQUFDLE9BQU8sQ0FBQyx3Q0FBd0MsRUFBRSxNQUFNLENBQUM7UUFFMUYsT0FBTyxJQUFJLE1BQU0sQ0FBQyxNQUFNLEdBQUcsV0FBVyxHQUFHLFFBQVEsR0FBRyxXQUFXLEdBQUcsZ0JBQWdCLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDM0YsQ0FBQzs7Ozs7O0lBRU8sc0JBQXNCLENBQUMsbUJBQTJCO1FBQ3hELElBQUk7WUFDRixPQUFPLGtCQUFrQixDQUFDLG1CQUFtQixDQUFDLENBQUM7U0FDaEQ7UUFBQyxXQUFNO1lBQ04sT0FBTyxtQkFBbUIsQ0FBQztTQUM1QjtJQUNILENBQUM7OztZQTNVRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7Ozs7WUFOeUMsY0FBYyx1QkFZbkQsTUFBTSxTQUFDLFdBQVc7Ozs7Ozs7O0lBSnJCLHVEQUErQzs7Ozs7SUFJN0MsNkNBQStEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0LCBQTEFURk9STV9JRCwgSW5qZWN0aW9uVG9rZW4gfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xyXG5pbXBvcnQgKiBhcyBDcnlwdG9KUyBmcm9tICdjcnlwdG8tanMnO1xyXG5cclxuQEluamVjdGFibGUoe1xyXG4gIHByb3ZpZGVkSW46ICdyb290JyxcclxufSlcclxuZXhwb3J0IGNsYXNzIE5neEVuY3J5cHRDb29raWVTZXJ2aWNlIHtcclxuICBwcml2YXRlIHJlYWRvbmx5IGRvY3VtZW50SXNBY2Nlc3NpYmxlOiBib29sZWFuO1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuXHJcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQ6IEluamVjdGlvblRva2VuPG9iamVjdD5cclxuICApIHtcclxuXHJcbiAgICB0aGlzLmRvY3VtZW50SXNBY2Nlc3NpYmxlID0gaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKTtcclxuICB9XHJcblxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIGtleVNpemUgQ29va2llIG5hbWVcclxuICAgKiBAcGFyYW0gcGFzc1BocmFzZSBzZWNyZXQgcGFzc1BocmFzZSBcclxuICAgKiBAcmV0dXJucyByZXR1cm5zIGtleSB3aGVuIHNldHRpbmcgY29va2llIGFuZCBnZXR0aW5nIGNvb2tpZVxyXG4gICAqIGRlZmF1bHQga2V5U2l6ZSBpcyAxMjgvMzIgYW5kIGRlZmF1bHQgcGFzc1BocmFzZSBpcyBcIlNlY3JldCBQYXNzUGhyYXNlXCJcclxuICAgKi9cclxuICBnZW5lcmF0ZUtleShrZXlTaXplPzogc3RyaW5nLCBwYXNzUGhyYXNlPzogc3RyaW5nKSB7XHJcblxyXG4gICAgdmFyIHNhbHQgPSBDcnlwdG9KUy5saWIuV29yZEFycmF5LnJhbmRvbSgxMjggLyA4KTtcclxuICAgIHZhciBrZXlTaXplQnl0ZXM7XHJcbiAgICB2YXIgc2VjcnRlUGFzc1BocmFzZTtcclxuXHJcbiAgICBrZXlTaXplID8ga2V5U2l6ZUJ5dGVzID0ga2V5U2l6ZSA6IGtleVNpemVCeXRlcyA9IFwiMTI4LzMyXCI7XHJcbiAgICBwYXNzUGhyYXNlID8gc2VjcnRlUGFzc1BocmFzZSA9IHBhc3NQaHJhc2UgOiBzZWNydGVQYXNzUGhyYXNlID0gXCJTZWNyZXQgUGFzc1BocmFzZVwiO1xyXG5cclxuICAgIHN3aXRjaCAoa2V5U2l6ZUJ5dGVzKSB7XHJcbiAgICAgIGNhc2UgXCIxMjgvMzJcIjogdmFyIG1zZyA9IENyeXB0b0pTLlBCS0RGMihzZWNydGVQYXNzUGhyYXNlLCBzYWx0LCB7IGtleVNpemU6IDEyOCAvIDMyIH0pXHJcbiAgICAgICAgcmV0dXJuIG1zZy50b1N0cmluZygpXHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGNhc2UgXCIyNTYvMzJcIjogdmFyIG1zZyA9IENyeXB0b0pTLlBCS0RGMihzZWNydGVQYXNzUGhyYXNlLCBzYWx0LCB7IGtleVNpemU6IDI1NiAvIDMyIH0pXHJcbiAgICAgICAgcmV0dXJuIG1zZy50b1N0cmluZygpXHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGNhc2UgXCI1MTIvMzJcIjogdmFyIG1zZyA9IENyeXB0b0pTLlBCS0RGMihzZWNydGVQYXNzUGhyYXNlLCBzYWx0LCB7IGtleVNpemU6IDUxMiAvIDMyIH0pXHJcbiAgICAgICAgcmV0dXJuIG1zZy50b1N0cmluZygpXHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqIFxyXG4gICAqIGVuY3J5cHQoKSBpcyBjYWxsaW5nIHdoZW4gc2V0KCkgY2FsbHNcclxuICAgKiBAcGFyYW0gdmFsIHZhbHVlIHRvIHN0b3JlIGluIGNvb2tpZXNcclxuICAgKiBAcGFyYW0gc2VjcmV0X2tleSBpcyBhIGtleSBnZW5lcmF0ZWQgYnkgdXNpbmcgZ2VuZXJhdGVLZXkoKSBvciB1c2VyIGRlZmluZWQga2V5LlxyXG4gICAqIEByZXR1cm5zIGVuY3J5cHRlZCB2YWwgdG8gc2V0KCkgYW5kIHRoZXJlIHRoZSBjb29raWUgd2lsbCBzZXQuIGlmIHVzZXIgZG9lc250IGdlbmVyYXRlS2V5IG9yIHBhc3Mga2V5IGVycm9yIHdpbGwgYmUgdGhyb3duLlxyXG4gICovXHJcbiAgcHJpdmF0ZSBlbmNyeXB0KHZhbDogU3RyaW5nLCBzZWNyZXRfa2V5OiBTdHJpbmcpIHtcclxuXHJcbiAgICBpZiAoc2VjcmV0X2tleSAhPSBudWxsIHx8IHNlY3JldF9rZXkgIT0gXCJcIiB8fCBzZWNyZXRfa2V5Lmxlbmd0aCA+IDApIHtcclxuICAgICAgdmFyIGVuY3J5cHRfbXNnID0gQ3J5cHRvSlMuQUVTLmVuY3J5cHQodmFsLCBzZWNyZXRfa2V5KTtcclxuICAgICAgcmV0dXJuIGVuY3J5cHRfbXNnO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJQYXNzIFNlY3JldCBrZXkgdG8gc2V0IGNvb2tpZVwiKTtcclxuICAgIH1cclxuICB9XHJcblxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogXHJcbiAgICogQHBhcmFtIGNvb2tpZV9uYW1lIGNvb2tpZSBuYW1lIHdoaWNoIGlzIHN0b3JlZFxyXG4gICAqIEBwYXJhbSBlbmNyeXB0ZWQgYm9vbGVhbiAtIGNvb2tpZSBzdG9yZWQgaGF2aW5nIGVuY3J5cHRlZCB2YWwgb3Igbm90XHJcbiAgICogQHBhcmFtIHNlY3JldF9rZXkgaXMga2V5IHdoaWNoIGlzIHVzZWQgdG8gZW5jcnlwdCBjb29raWUgdmFsLiBpdCBpcyBub3QgcmVxdWlyZWQgaWYgZW5jcnlwdGVkIGlzIGZhbHNlXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBkZWNyeXB0KGNvb2tpZU5hbWU6IHN0cmluZywgZW5jcnlwdGVkOiBib29sZWFuLCBzZWNyZXRfa2V5PzogU3RyaW5nLCApIHtcclxuICAgIGlmICh0aGlzLmRvY3VtZW50SXNBY2Nlc3NpYmxlICYmIHRoaXMuY2hlY2soY29va2llTmFtZSkpIHtcclxuICAgICAgY29va2llTmFtZSA9IGVuY29kZVVSSUNvbXBvbmVudChjb29raWVOYW1lKTtcclxuXHJcbiAgICAgIGNvbnN0IHJlZ0V4cDogUmVnRXhwID0gdGhpcy5nZXRDb29raWVSZWdFeHAoY29va2llTmFtZSk7XHJcbiAgICAgIGNvbnN0IHJlc3VsdDogUmVnRXhwRXhlY0FycmF5ID0gcmVnRXhwLmV4ZWMoZG9jdW1lbnQuY29va2llKTtcclxuXHJcbiAgICAgIGlmIChlbmNyeXB0ZWQpIHtcclxuICAgICAgICBpZiAoc2VjcmV0X2tleSkge1xyXG5cclxuICAgICAgICAgIGxldCBlbmNyeXB0X21zZyA9IHRoaXMuc2FmZURlY29kZVVSSUNvbXBvbmVudChyZXN1bHRbMV0pO1xyXG4gICAgICAgICAgbGV0IGRlY3J5cHRfbXNnID0gQ3J5cHRvSlMuQUVTLmRlY3J5cHQoZW5jcnlwdF9tc2csIHNlY3JldF9rZXkpO1xyXG4gICAgICAgICAgbGV0IG1lc3NhZ2UgPSBkZWNyeXB0X21zZy50b1N0cmluZyhDcnlwdG9KUy5lbmMuVXRmOCk7XHJcbiAgICAgICAgICByZXR1cm4gbWVzc2FnZTtcclxuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgY29uc29sZS5lcnJvcihcInBhc3Mgc2VjcmV0IGtleSB0byBnZXQgY29va2llIHZhbHVlXCIpXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNhZmVEZWNvZGVVUklDb21wb25lbnQocmVzdWx0WzFdKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSBjb29raWVOYW1lIENvb2tpZSBuYW1lXHJcbiAgICogQHJldHVybnMgYm9vbGVhbiAgd2hldGhlciBjb29raWUgd2l0aCBzcGVjaWZpZWQgbmFtZSBpcyBleGlzdGVkIG9yIG5vdFxyXG4gICAqL1xyXG4gIGNoZWNrKGNvb2tpZU5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgaWYgKCF0aGlzLmRvY3VtZW50SXNBY2Nlc3NpYmxlKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICB2YXIgbmFtZSA9IGVuY29kZVVSSUNvbXBvbmVudChjb29raWVOYW1lKTtcclxuXHJcbiAgICBjb25zdCByZWdFeHA6IFJlZ0V4cCA9IHRoaXMuZ2V0Q29va2llUmVnRXhwKG5hbWUpO1xyXG4gICAgY29uc3QgZXhpc3RzOiBib29sZWFuID0gcmVnRXhwLnRlc3QoZG9jdW1lbnQuY29va2llKTtcclxuXHJcbiAgICByZXR1cm4gZXhpc3RzO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIFxyXG4gICAqIEBwYXJhbSBjb29raWVOYW1lIGNvb2tpZSBuYW1lXHJcbiAgICogQHBhcmFtIGVuY3J5cHRpb24gYm9vbGVhbiAtIHdoZXRoZXIgdG8gd2FudCBlbmNyeXB0ZWQgb3IgZGVjcnlwdGVkIHZhbHVlLiBcclxuICAgKiBAcGFyYW0ga2V5IC0gaXQgc2hvdWxkIGVudGVyIGlmIGVuY3J5cHRlZD10cnVlIG90aGVyd2lzZSBlcnJvciB3aWxsIGJlIHRocm93bi5rZXkgY2FuIGJlIGVpdGhlciBnZW5lcmF0ZWQgdXNpbmcgZ2VuZXJhdGVLZXkoKSBvclxyXG4gICAgICAgICAgICAgICAgICAgdXNlciBkZWZpbmRlZCBrZXlcclxuICAgKi9cclxuICBnZXQoY29va2llTmFtZTogc3RyaW5nLCBlbmNyeXB0aW9uOiBib29sZWFuLCBrZXk/OiBzdHJpbmcsICk6IHN0cmluZyB7XHJcbiAgICB2YXIgdmFsOnN0cmluZztcclxuICAgICBpZihlbmNyeXB0aW9uKXtcclxuICAgICAgIGlmKGtleSl7XHJcbiAgICAgICAgdmFsID0gdGhpcy5kZWNyeXB0KGNvb2tpZU5hbWUsIGVuY3J5cHRpb24sIGtleSk7XHJcbiAgICAgICAgcmV0dXJuIHZhbDtcclxuICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGlmIGtleSBpcyBub3QgcGFzc2VkIG9yIGVuY3J5cHRlZCA9IGZhbHNlO1xyXG4gICAgdmFsID0gdGhpcy5kZWNyeXB0KGNvb2tpZU5hbWUsZmFsc2UsbnVsbCk7XHJcbiAgICByZXR1cm4gdmFsO1xyXG5cclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gZW5jcnlwdGVkIGJvb2xlYW4gLSB0byBrbm93IGVuY3J5cHRlZCB2YWx1ZXMgYXJlIHRoZXJlXHJcbiAgICogQHBhcmFtIGtleSAgZ2VuZXJhdGVkS2V5KCkgb3IgdXNlciBkZWZpbmVkIGtleSAtIHRvIGRlY3J5cHQgZW5jcnlwdGVkIHZhbHVlc1xyXG4gICAqIEByZXR1cm5zIGNvb2tpZXMgLSBhbGwgdGhlIGNvb2tpZXMgIHN0b3JlZFxyXG4gICAqL1xyXG4gIGdldEFsbChlbmNyeXB0ZWQ/OiBib29sZWFuLCBrZXk/OiBzdHJpbmcpOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9IHtcclxuICAgIGlmICghdGhpcy5kb2N1bWVudElzQWNjZXNzaWJsZSkge1xyXG4gICAgICByZXR1cm4ge307XHJcbiAgICB9XHJcbiAgICBjb25zdCBjb29raWVzOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9ID0ge307XHJcblxyXG4gICAgaWYgKGVuY3J5cHRlZCkge1xyXG4gICAgICBpZiAoZG9jdW1lbnQuY29va2llICYmIGRvY3VtZW50LmNvb2tpZSAhPT0gJycpIHtcclxuXHJcbiAgICAgICAgZG9jdW1lbnQuY29va2llLnNwbGl0KCc7JykuZm9yRWFjaCgoY3VycmVudENvb2tpZSkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgW2Nvb2tpZU5hbWUsIGNvb2tpZVZhbHVlXSA9IGN1cnJlbnRDb29raWUuc3BsaXQoJz0nKTtcclxuICAgICAgICAgIHZhciBjb29raWVfbmFtZSA9IHRoaXMuc2FmZURlY29kZVVSSUNvbXBvbmVudChjb29raWVOYW1lLnJlcGxhY2UoL14gLywgJycpKTtcclxuICAgICAgICAgIHZhciBjb29raWVfdmFsID0gdGhpcy5nZXQoY29va2llX25hbWUsIGVuY3J5cHRlZCwga2V5KVxyXG4gICAgICAgICAgY29va2llc1t0aGlzLnNhZmVEZWNvZGVVUklDb21wb25lbnQoY29va2llTmFtZS5yZXBsYWNlKC9eIC8sICcnKSldID0gY29va2llX3ZhbFxyXG4gICAgICAgICAgLy8gY29va2llc1tdXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICBpZiAoZG9jdW1lbnQuY29va2llICYmIGRvY3VtZW50LmNvb2tpZSAhPT0gJycpIHtcclxuXHJcbiAgICAgICAgZG9jdW1lbnQuY29va2llLnNwbGl0KCc7JykuZm9yRWFjaCgoY3VycmVudENvb2tpZSkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgW2Nvb2tpZU5hbWUsIGNvb2tpZVZhbHVlXSA9IGN1cnJlbnRDb29raWUuc3BsaXQoJz0nKTtcclxuICAgICAgICAgIHZhciBjb29raWVfbmFtZSA9IHRoaXMuc2FmZURlY29kZVVSSUNvbXBvbmVudChjb29raWVOYW1lLnJlcGxhY2UoL14gLywgJycpKTtcclxuICAgICAgICAgIGNvb2tpZXNbdGhpcy5zYWZlRGVjb2RlVVJJQ29tcG9uZW50KGNvb2tpZU5hbWUucmVwbGFjZSgvXiAvLCAnJykpXSA9IHRoaXMuc2FmZURlY29kZVVSSUNvbXBvbmVudChjb29raWVWYWx1ZSlcclxuICAgICAgICAgIC8vIGNvb2tpZXNbXVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGNvb2tpZXNcclxuICB9XHJcblxyXG5cclxuICBwcml2YXRlIGdldEFsbENvb2tpZXMoKSB7XHJcbiAgICBpZiAoIXRoaXMuZG9jdW1lbnRJc0FjY2Vzc2libGUpIHtcclxuICAgICAgcmV0dXJuIHt9O1xyXG4gICAgfVxyXG4gICAgY29uc3QgY29va2llczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xyXG5cclxuICAgIGlmIChkb2N1bWVudC5jb29raWUgJiYgZG9jdW1lbnQuY29va2llICE9PSAnJykge1xyXG5cclxuICAgICAgZG9jdW1lbnQuY29va2llLnNwbGl0KCc7JykuZm9yRWFjaCgoY3VycmVudENvb2tpZSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IFtjb29raWVOYW1lLCBjb29raWVWYWx1ZV0gPSBjdXJyZW50Q29va2llLnNwbGl0KCc9Jyk7XHJcbiAgICAgICAgdmFyIGNvb2tpZV9uYW1lID0gdGhpcy5zYWZlRGVjb2RlVVJJQ29tcG9uZW50KGNvb2tpZU5hbWUucmVwbGFjZSgvXiAvLCAnJykpO1xyXG4gICAgICAgIGNvb2tpZXNbdGhpcy5zYWZlRGVjb2RlVVJJQ29tcG9uZW50KGNvb2tpZU5hbWUucmVwbGFjZSgvXiAvLCAnJykpXSA9IHRoaXMuc2FmZURlY29kZVVSSUNvbXBvbmVudChjb29raWVWYWx1ZSlcclxuICAgICAgICAvLyBjb29raWVzW11cclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGNvb2tpZXNcclxuICB9XHJcblxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIG5hbWUgICAgIENvb2tpZSBuYW1lXHJcbiAgICogQHBhcmFtIHZhbHVlICAgIENvb2tpZSB2YWx1ZVxyXG4gICAqIEBwYXJhbSBlbmNyeXB0ICBib29sZWFuIC0gdG8gZW5jcnlwdCBjb29raWUgdmFsdWUgb3Igbm90XHJcbiAgICogQHBhcmFtIGtleSAgICAgIGEga2V5IGNhbiBlaXRoZXIgZ2VuZXJhdGUgdXNpbmcgZ2VuZXJhdGVLZXkoKSBvciB1c2VyIGRlZmluZWQga2V5IFxyXG4gICAqIEBwYXJhbSBleHBpcmVzICBOdW1iZXIgb2YgZGF5cyB1bnRpbCB0aGUgY29va2llcyBleHBpcmVzIG9yIGFuIGFjdHVhbCBgRGF0ZWBcclxuICAgKiBAcGFyYW0gcGF0aCAgICAgQ29va2llIHBhdGggKGVnOlwiL1wiKVxyXG4gICAqIEBwYXJhbSBkb21haW4gICBDb29raWUgZG9tYWluIChlZzpcImRvbWFpbi5jb21cIilcclxuICAgKiBAcGFyYW0gc2VjdXJlICAgU2VjdXJlIGZsYWdcclxuICAgKiBAcGFyYW0gc2FtZVNpdGUgT1dBU1Agc2FtZXNpdGUgdG9rZW4gYExheGAsIGBOb25lYCwgb3IgYFN0cmljdGAuIERlZmF1bHRzIHRvIGBMYXhgXHJcbiAgICovXHJcbiAgc2V0KFxyXG4gICAgbmFtZTogc3RyaW5nLFxyXG4gICAgdmFsdWU6IHN0cmluZyxcclxuICAgIGVuY3J5cHQ6IGJvb2xlYW4sXHJcbiAgICBrZXk/OiBzdHJpbmcsXHJcbiAgICBleHBpcmVzPzogbnVtYmVyIHwgRGF0ZSxcclxuICAgIHBhdGg/OiBzdHJpbmcsXHJcbiAgICBkb21haW4/OiBzdHJpbmcsXHJcbiAgICBzZWN1cmU/OiBib29sZWFuLFxyXG4gICAgc2FtZVNpdGU6ICdMYXgnIHwgJ05vbmUnIHwgJ1N0cmljdCcgPSAnTGF4J1xyXG4gICk6IGFueSB7XHJcbiAgICB2YXIgY29va2llU3RyaW5nOiBzdHJpbmc7XHJcblxyXG4gICAgaWYgKCF0aGlzLmRvY3VtZW50SXNBY2Nlc3NpYmxlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZW5jcnlwdCkge1xyXG4gICAgIGlmKGtleSl7XHJcbiAgICAgIGxldCBlbmNyeXB0ZWRfbXNnID0gdGhpcy5lbmNyeXB0KHZhbHVlLCBrZXkpXHJcbiAgICAgIGNvb2tpZVN0cmluZyA9IGVuY29kZVVSSUNvbXBvbmVudChuYW1lKSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudChlbmNyeXB0ZWRfbXNnKSArICc7JztcclxuICAgICB9XHJcbiAgICAgZWxzZXtcclxuICAgICAgIGNvbnNvbGUuZXJyb3IoXCJwYXNzIGtleSB0byBlbmNyeXB0IGNvb2tpZSB2YWx1ZVwiKTtcclxuICAgICAgIHJldHVybiBcImtleSBmYWlsXCI7XHJcbiAgICAgfVxyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIGNvb2tpZVN0cmluZyA9IGVuY29kZVVSSUNvbXBvbmVudChuYW1lKSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkgKyAnOyc7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGV4cGlyZXMpIHtcclxuICAgICAgaWYgKHR5cGVvZiBleHBpcmVzID09PSAnbnVtYmVyJykge1xyXG4gICAgICAgIGNvbnN0IGRhdGVFeHBpcmVzOiBEYXRlID0gbmV3IERhdGUobmV3IERhdGUoKS5nZXRUaW1lKCkgKyBleHBpcmVzICogMTAwMCAqIDYwICogNjAgKiAyNCk7XHJcblxyXG4gICAgICAgIGNvb2tpZVN0cmluZyArPSAnZXhwaXJlcz0nICsgZGF0ZUV4cGlyZXMudG9VVENTdHJpbmcoKSArICc7JztcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb29raWVTdHJpbmcgKz0gJ2V4cGlyZXM9JyArIGV4cGlyZXMudG9VVENTdHJpbmcoKSArICc7JztcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChwYXRoKSB7XHJcbiAgICAgIGNvb2tpZVN0cmluZyArPSAncGF0aD0nICsgcGF0aCArICc7JztcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZG9tYWluKSB7XHJcbiAgICAgIGNvb2tpZVN0cmluZyArPSAnZG9tYWluPScgKyBkb21haW4gKyAnOyc7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHNlY3VyZSA9PT0gZmFsc2UgJiYgc2FtZVNpdGUgPT09ICdOb25lJykge1xyXG4gICAgICBzZWN1cmUgPSB0cnVlO1xyXG4gICAgICBjb25zb2xlLndhcm4oXHJcbiAgICAgICAgYFtuZ3gtc2VjdXJlLWNvb2tpZXNdIENvb2tpZSAke25hbWV9IHdhcyBmb3JjZWQgd2l0aCBzZWN1cmUgZmxhZyBiZWNhdXNlIHNhbWVTaXRlPU5vbmUuYCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHNlY3VyZSkge1xyXG4gICAgICBjb29raWVTdHJpbmcgKz0gJ3NlY3VyZTsnO1xyXG4gICAgfVxyXG5cclxuICAgIGNvb2tpZVN0cmluZyArPSAnc2FtZVNpdGU9JyArIHNhbWVTaXRlICsgJzsnO1xyXG5cclxuICAgIGRvY3VtZW50LmNvb2tpZSA9IGNvb2tpZVN0cmluZztcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIG5hbWUgICBDb29raWUgbmFtZVxyXG4gICAqIEBwYXJhbSBwYXRoICAgQ29va2llIHBhdGhcclxuICAgKiBAcGFyYW0gZG9tYWluIENvb2tpZSBkb21haW5cclxuICAgKi9cclxuXHJcbiAgZGVsZXRlKG5hbWU6IHN0cmluZywgcGF0aD86IHN0cmluZywgZG9tYWluPzogc3RyaW5nLCBzZWN1cmU/OiBib29sZWFuLCBzYW1lU2l0ZTogJ0xheCcgfCAnTm9uZScgfCAnU3RyaWN0JyA9ICdMYXgnKTogdm9pZCB7XHJcbiAgICBpZiAoIXRoaXMuZG9jdW1lbnRJc0FjY2Vzc2libGUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuc2V0KG5hbWUsICcnLCBmYWxzZSwgXCJcIiwgbmV3IERhdGUoJ1RodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDEgR01UJyksIHBhdGgsIGRvbWFpbiwgc2VjdXJlLCBzYW1lU2l0ZSk7XHJcbiAgfVxyXG5cclxuXHJcblxyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gcGF0aCAgIENvb2tpZSBwYXRoXHJcbiAgICogQHBhcmFtIGRvbWFpbiBDb29raWUgZG9tYWluXHJcbiAgICovXHJcbiAgZGVsZXRlQWxsKHBhdGg/OiBzdHJpbmcsIGRvbWFpbj86IHN0cmluZywgc2VjdXJlPzogYm9vbGVhbiwgc2FtZVNpdGU6ICdMYXgnIHwgJ05vbmUnIHwgJ1N0cmljdCcgPSAnTGF4Jyk6IHZvaWQge1xyXG4gICAgaWYgKCF0aGlzLmRvY3VtZW50SXNBY2Nlc3NpYmxlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBjb29raWVzOiBhbnkgPSB0aGlzLmdldEFsbENvb2tpZXMoKTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IGNvb2tpZU5hbWUgaW4gY29va2llcykge1xyXG4gICAgICBpZiAoY29va2llcy5oYXNPd25Qcm9wZXJ0eShjb29raWVOYW1lKSkge1xyXG4gICAgICAgIHRoaXMuZGVsZXRlKGNvb2tpZU5hbWUsIHBhdGgsIGRvbWFpbiwgc2VjdXJlLCBzYW1lU2l0ZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG5cclxuXHJcblxyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gbmFtZSBDb29raWUgbmFtZVxyXG4gICAqIEByZXR1cm5zIHByb3BlcnR5IFJlZ0V4cFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Q29va2llUmVnRXhwKG5hbWU6IHN0cmluZyk6IFJlZ0V4cCB7XHJcbiAgICBjb25zdCBlc2NhcGVkTmFtZTogc3RyaW5nID0gbmFtZS5yZXBsYWNlKC8oW1xcW1xcXVxce1xcfVxcKFxcKVxcfFxcPVxcO1xcK1xcP1xcLFxcLlxcKlxcXlxcJF0pL2dpLCAnXFxcXCQxJyk7XHJcblxyXG4gICAgcmV0dXJuIG5ldyBSZWdFeHAoJyg/Ol4nICsgZXNjYXBlZE5hbWUgKyAnfDtcXFxccyonICsgZXNjYXBlZE5hbWUgKyAnKT0oLio/KSg/Ojt8JCknLCAnZycpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzYWZlRGVjb2RlVVJJQ29tcG9uZW50KGVuY29kZWRVUklDb21wb25lbnQ6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICB0cnkge1xyXG4gICAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KGVuY29kZWRVUklDb21wb25lbnQpO1xyXG4gICAgfSBjYXRjaCB7XHJcbiAgICAgIHJldHVybiBlbmNvZGVkVVJJQ29tcG9uZW50O1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=